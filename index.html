<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Metadatos de App Móvil -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Billetera Pro">
    
    <!-- Iconos -->
    <link rel="apple-touch-icon" href="img.jpg">
    <link rel="icon" type="image/jpeg" href="img.jpg">
    <meta name="theme-color" content="#020617">
    
    <!-- Enlace al archivo Manifest externo -->
    <link rel="manifest" href="manifest.json">

    <title>Billetera Pro - PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root {
            --navy-dark: #020617;
            --navy-surface: #0f172a;
            --cyan-accent: #22d3ee;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--navy-dark);
            color: #f1f5f9;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .view { display: none; }
        .view.active { display: block; animation: slideUp 0.3s ease-out; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            height: 65px;
            border-radius: 30px;
            z-index: 100;
        }

        input {
            background: rgba(30, 41, 59, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }
    </style>
</head>
<body class="pb-28">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 p-6 flex justify-between items-center rounded-b-3xl">
        <div class="flex items-center gap-3">
            <img src="img.jpg" class="w-10 h-10 rounded-xl object-cover border border-cyan-500/30" onerror="this.src='https://via.placeholder.com/40'">
            <div>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Balance Total</p>
                <h1 id="display-balance" class="text-xl font-extrabold">$ 0</h1>
            </div>
        </div>
        <button onclick="document.getElementById('modal-add').classList.add('active')" class="bg-cyan-500 text-slate-900 w-9 h-9 rounded-full flex items-center justify-center active:scale-90 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
        </button>
    </nav>

    <!-- POS VIEW -->
    <div id="view-pos" class="view active p-5 space-y-6">
        <div id="product-grid" class="grid grid-cols-2 gap-3"></div>

        <div class="glass p-6 rounded-3xl space-y-4">
            <div id="cart-list" class="space-y-2 text-sm max-h-32 overflow-y-auto"></div>
            <div class="flex justify-between items-center pt-2 border-t border-white/5">
                <span class="text-slate-400 text-xs font-bold uppercase">Total</span>
                <span id="cart-total" class="text-3xl font-black text-white">$ 0</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="pay-with" oninput="updateChange()" placeholder="Paga con" class="p-3 rounded-xl text-sm font-bold">
                <div id="change-box" class="flex items-center justify-center bg-slate-800 rounded-xl text-xs font-bold text-emerald-400">Vuelto: $0</div>
            </div>
            <button onclick="processSale()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-2xl font-bold active:scale-95 shadow-lg shadow-cyan-500/20">COBRAR AHORA</button>
        </div>
    </div>

    <!-- CASH VIEW -->
    <div id="view-cash" class="view p-5 space-y-4">
        <div class="glass p-6 rounded-3xl space-y-5">
            <h2 class="text-center font-bold text-lg">Ajuste de Caja</h2>
            <div class="flex bg-slate-900 p-1 rounded-xl">
                <button id="btn-inc" onclick="setMode('in')" class="flex-1 py-2 rounded-lg text-xs font-bold bg-blue-600">INGRESO</button>
                <button id="btn-exp" onclick="setMode('out')" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500">EGRESO</button>
            </div>
            <input type="number" id="cash-val" placeholder="0.00" class="w-full p-4 rounded-xl text-2xl font-black text-center">
            <input type="text" id="cash-desc" placeholder="Motivo..." class="w-full p-4 rounded-xl text-sm">
            <button onclick="doCashMovement()" class="w-full py-4 bg-white text-slate-900 rounded-2xl font-black uppercase tracking-tighter active:scale-95">REGISTRAR</button>
        </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar glass flex items-center justify-around px-4">
        <button onclick="showView('view-pos')" id="tab-pos" class="flex flex-col items-center gap-1 text-cyan-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" stroke-width="2"/></svg>
            <span class="text-[8px] font-bold uppercase">Tienda</span>
        </button>
        <button onclick="showView('view-cash')" id="tab-cash" class="flex flex-col items-center gap-1 text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
            <span class="text-[8px] font-bold uppercase">Caja</span>
        </button>
    </div>

    <!-- Modal Añadir Producto -->
    <div id="modal-add" class="fixed inset-0 z-[110] bg-black/80 flex items-end justify-center opacity-0 pointer-events-none transition-opacity [&.active]:opacity-100 [&.active]:pointer-events-auto">
        <div class="glass w-full max-w-md rounded-t-[2.5rem] p-8 space-y-4">
            <h3 class="font-bold">Nuevo Producto</h3>
            <input type="text" id="p-name" placeholder="Nombre" class="w-full p-4 rounded-xl">
            <input type="number" id="p-price" placeholder="Precio" class="w-full p-4 rounded-xl">
            <button onclick="saveProduct()" class="w-full py-4 bg-cyan-500 text-slate-900 rounded-2xl font-bold">GUARDAR</button>
            <button onclick="document.getElementById('modal-add').classList.remove('active')" class="w-full py-2 text-slate-500 text-xs font-bold uppercase">Cancelar</button>
        </div>
    </div>

    <script>
        // Registro del Service Worker externo
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado', reg))
                    .catch(err => console.warn('Error al registrar Service Worker', err));
            });
        }

        // --- LÓGICA DE LA APP ---
        let state = JSON.parse(localStorage.getItem('billetera_data')) || {
            balance: 0,
            products: [{id: 1, name: 'Combo Simple', price: 1500}],
            mode: 'in'
        };

        let cart = [];

        function save() {
            localStorage.setItem('billetera_data', JSON.stringify(state));
            render();
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Actualizar colores de la tab bar
            document.getElementById('tab-pos').classList.toggle('text-cyan-400', id === 'view-pos');
            document.getElementById('tab-pos').classList.toggle('text-slate-400', id !== 'view-pos');
            document.getElementById('tab-cash').classList.toggle('text-cyan-400', id === 'view-cash');
            document.getElementById('tab-cash').classList.toggle('text-slate-400', id !== 'view-cash');
        }

        function addToCart(id) {
            const p = state.products.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.qty++; else cart.push({...p, qty:1});
            render();
        }

        function updateChange() {
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const pay = parseFloat(document.getElementById('pay-with').value) || 0;
            const changeBox = document.getElementById('change-box');
            if (pay >= total && total > 0) {
                changeBox.innerText = `Vuelto: $${(pay-total).toLocaleString()}`;
                changeBox.className = "flex items-center justify-center bg-slate-800 rounded-xl text-xs font-bold text-emerald-400";
            } else {
                changeBox.innerText = total > 0 ? "Falta dinero" : "Esperando...";
                changeBox.className = "flex items-center justify-center bg-slate-800 rounded-xl text-xs font-bold text-rose-400";
            }
        }

        function processSale() {
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            if(total === 0) return;
            state.balance += total;
            cart = [];
            document.getElementById('pay-with').value = '';
            save();
        }

        function setMode(m) {
            state.mode = m;
            document.getElementById('btn-inc').className = m === 'in' ? 'flex-1 py-2 rounded-lg text-xs font-bold bg-blue-600' : 'flex-1 py-2 rounded-lg text-xs font-bold text-slate-500';
            document.getElementById('btn-exp').className = m === 'out' ? 'flex-1 py-2 rounded-lg text-xs font-bold bg-rose-600 text-white' : 'flex-1 py-2 rounded-lg text-xs font-bold text-slate-500';
        }

        function doCashMovement() {
            const val = parseFloat(document.getElementById('cash-val').value) || 0;
            if(val <= 0) return;
            state.balance += (state.mode === 'in' ? val : -val);
            document.getElementById('cash-val').value = '';
            document.getElementById('cash-desc').value = '';
            save();
            showView('view-pos');
        }

        function saveProduct() {
            const n = document.getElementById('p-name').value;
            const p = parseFloat(document.getElementById('p-price').value);
            if(!n || !p) return;
            state.products.push({id: Date.now(), name: n, price: p});
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('modal-add').classList.remove('active');
            save();
        }

        function render() {
            document.getElementById('display-balance').innerText = `$ ${state.balance.toLocaleString()}`;
            
            const grid = document.getElementById('product-grid');
            grid.innerHTML = state.products.map(p => `
                <button onclick="addToCart(${p.id})" class="glass p-4 rounded-2xl text-left active:scale-95 transition-transform">
                    <p class="text-[10px] text-slate-400 font-bold uppercase truncate">${p.name}</p>
                    <p class="text-lg font-bold text-cyan-400">$ ${p.price.toLocaleString()}</p>
                </button>
            `).join('');

            const cartEl = document.getElementById('cart-list');
            cartEl.innerHTML = cart.map(i => `
                <div class="flex justify-between items-center py-1">
                    <span class="truncate pr-2">${i.qty}x ${i.name}</span>
                    <span class="font-bold text-cyan-500 whitespace-nowrap">$ ${(i.qty*i.price).toLocaleString()}</span>
                </div>
            `).join('');

            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            document.getElementById('cart-total').innerText = `$ ${total.toLocaleString()}`;
            updateChange();
        }

        window.onload = render;
    </script>
</body>
</html>
